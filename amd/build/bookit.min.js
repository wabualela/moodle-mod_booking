define("mod_booking/bookit",["exports","core/ajax","core/templates","core/notification","local_wunderbyte_table/reload","mod_booking/bookingpage/prepageFooter"],(function(_exports,_ajax,_templates,_notification,_reload,_prepageFooter){Object.defineProperty(_exports,"__esModule",{value:!0}),_exports.SELECTORS=void 0,_exports.backToPreviousPage=function(optionid,userid){currentbookitpage[optionid]--,loadPreBookingPage(optionid,userid)},_exports.bookit=bookit,_exports.continueToNextPage=function(optionid,userid){console.log("continueToNextPage",optionid,userid,currentbookitpage[optionid],totalbookitpages[optionid]),currentbookitpage[optionid]<totalbookitpages[optionid]&&(currentbookitpage[optionid]++,loadPreBookingPage(optionid,userid))},_exports.loadPreBookingPage=_exports.initprepagemodal=_exports.initprepageinline=_exports.initbookitbutton=void 0,_exports.setBackModalVariables=function(optionid){currentbookitpage[optionid]=0},_ajax=_interopRequireDefault(_ajax),_templates=_interopRequireDefault(_templates),_notification=_interopRequireDefault(_notification);var _systemImportTransformerGlobalIdentifier="undefined"!=typeof window?window:"undefined"!=typeof self?self:"undefined"!=typeof global?global:{};function _interopRequireDefault(obj){return obj&&obj.__esModule?obj:{default:obj}}var currentbookitpage={},totalbookitpages={},SELECTORS={MODALID:"sbPrePageModal_",INLINEID:"sbPrePageInline_",INMODALDIV:" div.modalMainContent",MODALHEADER:"div.modalHeader",MODALBUTTONAREA:"div.modalButtonArea",MODALFOOTER:"div.modalFooter",CONTINUEBUTTON:"a.continue-button",BACKBUTTON:"a.back-button",BOOKITBUTTON:"div.booking-button-area.noprice",INMODALBUTTON:"div.in-modal-button",STATICBACKDROP:"div.modal-backdrop"};_exports.SELECTORS=SELECTORS;const initbookitbutton=(itemid,area)=>{const initselector=SELECTORS.BOOKITBUTTON+"[data-itemid][data-area]";if(!itemid||!area){return void document.querySelectorAll(initselector).forEach((button=>{const inititemid=button.dataset.itemid,initarea=button.dataset.area;initbookitbutton(inititemid,initarea)}))}const selector=SELECTORS.BOOKITBUTTON+'[data-itemid="'+itemid+'"][data-area="'+area+'"]',buttons=document.querySelectorAll(selector);buttons&&buttons.forEach((button=>{if(!button.dataset.nojs&&!button.classList.contains("disabled")&&!button.dataset.initialized){button.dataset.initialized="true";const userid=button.dataset.userid;button.addEventListener("click",(e=>{const data=button.dataset;e.target.classList.contains("shopping-cart-cancel-button")?("function"==typeof _systemImportTransformerGlobalIdentifier.define&&_systemImportTransformerGlobalIdentifier.define.amd?new Promise((function(resolve,reject){_systemImportTransformerGlobalIdentifier.require(["local_shopping_cart/shistory"],resolve,reject)})):"undefined"!=typeof module&&module.exports&&"undefined"!=typeof require||"undefined"!=typeof module&&module.component&&_systemImportTransformerGlobalIdentifier.require&&"component"===_systemImportTransformerGlobalIdentifier.require.loader?Promise.resolve(require("local_shopping_cart/shistory")):Promise.resolve(_systemImportTransformerGlobalIdentifier["local_shopping_cart/shistory"])).then((shoppingcart=>{(0,shoppingcart.confirmCancelModal)(button,0)})).catch((err=>{console.log(err)})):e.target.classList.contains("btn")&&(!e.target.href||e.target.href.length<2)&&bookit(itemid,area,userid,data)}))}}))};function bookit(itemid,area,userid,data){console.log("run bookit"),_ajax.default.call([{methodname:"mod_booking_bookit",args:{itemid:itemid,area:area,userid:userid,data:JSON.stringify(data)},done:function(res){var skipreload=!1;document.querySelector(".booking-elective-component")&&window.location.reload();const jsonarray=JSON.parse(res.json),templates=res.template.split(","),buttons=document.querySelectorAll(SELECTORS.BOOKITBUTTON+"[data-itemid='"+itemid+"'][data-area='"+area+"']"),promises=[];buttons.forEach((button=>{if(console.log("bookit values",button.dataset.nojs,res.status),skipreload=!0,1==button.dataset.nojs&&0==res.status)console.log("bookit skip",button.dataset.nojs,res.status);else{const arraytoreduce=[...jsonarray];1==res.status&&(skipreload=!1),templates.forEach((template=>{var _data$data;const data=arraytoreduce.shift(),datatorender=null!==(_data$data=data.data)&&void 0!==_data$data?_data$data:data,promise=_templates.default.renderForPromise(template,datatorender).then((_ref=>{let{html:html,js:js}=_ref;return _templates.default.replaceNode(button,html,js),!0})).catch((ex=>{_notification.default.addNotification({message:"failed rendering "+ex,type:"danger"})}));promises.push(promise)}))}})),Promise.all(promises).then((()=>{const backdrop=document.querySelector(SELECTORS.STATICBACKDROP);return("subbooking"===area||currentbookitpage[itemid]<totalbookitpages[itemid])&&(skipreload=!0),console.log("skipreload",skipreload,currentbookitpage[itemid],totalbookitpages[itemid]),backdrop||skipreload||(0,_reload.reloadAllTables)(),!0})).catch((e=>{console.log(e)}))}}])}_exports.initbookitbutton=initbookitbutton;const initprepagemodal=(optionid,userid,totalnumberofpages,uniquid)=>{if(console.log("initprepagemodal",optionid,userid,totalnumberofpages,uniquid),optionid&&uniquid&&totalnumberofpages)currentbookitpage[optionid]=0,totalbookitpages[optionid]=totalnumberofpages,function(optionid,userid,uniquid,totalnumberofpages,callback){document.querySelectorAll("[id^="+SELECTORS.MODALID+optionid+"_"+uniquid+"]").forEach((element=>{if(element&&"true"!=element.dataset.initialized){element.dataset.initialized=!0;for(var observer=new MutationObserver((function(){isHidden(element)||element.classList.contains("show")&&callback(optionid,userid,uniquid,totalnumberofpages)}));null!==element;){if(isHidden(element)){if(element.dataset.observed)return;return observer.observe(element,{attributes:!0}),void(element.dataset.observed=!0)}element=element.parentElement}callback(optionid,userid,uniquid,totalnumberofpages)}}))}(optionid,userid,uniquid,totalnumberofpages,loadPreBookingPage);else{document.querySelectorAll("[id^="+SELECTORS.MODALID).forEach((element=>{element.querySelector('[data-action="bookondetail"]')?console.log("bookondetail abort"):(optionid=element.dataset.optionid,uniquid=element.dataset.uniquid,userid=element.dataset.userid,totalnumberofpages=element.dataset.pages,optionid&&uniquid&&initprepagemodal(optionid,userid,totalnumberofpages,uniquid))}))}};_exports.initprepagemodal=initprepagemodal;const initprepageinline=(optionid,userid,totalnumberofpages,uniquid)=>{if(console.log("initprepageinline",optionid,userid,totalnumberofpages,uniquid),!optionid||!uniquid||!totalnumberofpages){const elements=document.querySelectorAll("[id^="+SELECTORS.INLINEID);return console.log(elements),void elements.forEach((element=>{optionid=element.dataset.optionid,uniquid=element.dataset.uniquid,userid=element.dataset.userid,totalnumberofpages=element.dataset.pages,optionid&&uniquid&&initprepageinline(optionid,userid,totalnumberofpages,uniquid)}))}currentbookitpage[optionid]=0,totalbookitpages[optionid]=totalnumberofpages;document.querySelectorAll('[data-itemid="'+optionid+'"][data-area="option"]').forEach((button=>{button.dataset.initialized||(button.dataset.initialized=!0,console.log("add listener to button",button,button.dataset.action),button.querySelector('[data-action="bookondetail"]')?console.log("bookondetail abort"):button.addEventListener("click",(e=>{console.log("e.target",e.target);let rowcontainer=e.target.closest(".mod-booking-row");if(!rowcontainer.lastElementChild.classList.contains("inlineprepagearea")){let inlinediv=returnVisibleElement(optionid,uniquid,SELECTORS.INMODALDIV);rowcontainer.append(inlinediv.closest(".inlineprepagearea")),loadPreBookingPage(optionid,userid,uniquid)}})))}))};function isHidden(el){var style=window.getComputedStyle(el);return"none"===style.display||"hidden"===style.visibility}_exports.initprepageinline=initprepageinline;const loadPreBookingPage=function(optionid){let userid=arguments.length>1&&void 0!==arguments[1]?arguments[1]:0,uniquid=arguments.length>2&&void 0!==arguments[2]?arguments[2]:"";const element=returnVisibleElement(optionid,uniquid,SELECTORS.INMODALDIV);if(element)for(;element.firstChild;)element.removeChild(element.firstChild);else console.error("didnt find element");_ajax.default.call([{methodname:"mod_booking_allow_add_item_to_cart",args:{itemid:optionid,userid:userid},done:function(response){return 1==response.success||5==response.success||0==response.success?_ajax.default.call([{methodname:"mod_booking_load_pre_booking_page",args:{optionid:optionid,userid:userid,pagenumber:currentbookitpage[optionid]},done:function(res){currentbookitpage[optionid]===totalbookitpages[optionid]-1&&(currentbookitpage[optionid]=0);const jsonobject=JSON.parse(res.json);renderTemplatesOnPage(res.template.split(","),jsonobject,element)},fail:function(err){console.log(err)}}]):(console.log("closeModal"),(0,_prepageFooter.closeModal)(optionid,!1),(0,_prepageFooter.closeInline)(optionid,!1),("function"==typeof _systemImportTransformerGlobalIdentifier.define&&_systemImportTransformerGlobalIdentifier.define.amd?new Promise((function(resolve,reject){_systemImportTransformerGlobalIdentifier.require(["local_shopping_cart/cart"],resolve,reject)})):"undefined"!=typeof module&&module.exports&&"undefined"!=typeof require||"undefined"!=typeof module&&module.component&&_systemImportTransformerGlobalIdentifier.require&&"component"===_systemImportTransformerGlobalIdentifier.require.loader?Promise.resolve(require("local_shopping_cart/cart")):Promise.resolve(_systemImportTransformerGlobalIdentifier["local_shopping_cart/cart"])).then((shoppingcart=>{const addItemShowNotification=shoppingcart.addItemShowNotification;response.userid=userid,addItemShowNotification(response)})).catch((err=>{console.log(err)}))),!0},fail:function(err){console.log(err)}}])};async function renderTemplatesOnPage(templates,dataarray,element){const modal=element.closest(".prepage-body");let elementid=modal.id;if(!elementid){const parent=modal.closest("[id]");elementid=parent.id}console.log(modal,elementid),modal.querySelector(SELECTORS.MODALHEADER).innerHTML="",modal.querySelector(SELECTORS.INMODALDIV).innerHTML="",modal.querySelector(SELECTORS.MODALBUTTONAREA).innerHTML="",modal.querySelector(SELECTORS.MODALFOOTER).innerHTML="";var counter=0;return templates.forEach((async template=>{const data=dataarray.shift();let targetelement=element;if(!data)return!0;switch(data.data.elementid=elementid,template){case"mod_booking/bookingpage/header":targetelement=modal.querySelector(SELECTORS.MODALHEADER);break;case"mod_booking/bookit_button":case"mod_booking/bookit_price":targetelement=modal.querySelector(SELECTORS.MODALBUTTONAREA);break;case"mod_booking/bookingpage/footer":targetelement=modal.querySelector(SELECTORS.MODALFOOTER);break;default:targetelement=modal.querySelector(SELECTORS.INMODALDIV)}return console.log(data.data),await _templates.default.renderForPromise(template,data.data).then((_ref2=>{let{html:html,js:js}=_ref2;return counter<1?(counter++,_templates.default.replaceNodeContents(targetelement,html,js)):_templates.default.appendNodeContents(targetelement,html,js),!0})).catch((ex=>{_notification.default.addNotification({message:"failed rendering "+JSON.stringify(ex),type:"danger"})})),!0})),!0}function returnVisibleElement(optionid,uniquid,appendedSelector){let selector='[id^="'+SELECTORS.MODALID+optionid+"_"+uniquid+'"] '+appendedSelector;uniquid&&0!==uniquid.length||(selector='[id^="'+SELECTORS.MODALID+optionid+'_"].show '+appendedSelector);let elements=document.querySelectorAll(selector);0===elements.length&&(selector='[id^="'+SELECTORS.INLINEID+optionid+'_"] '+appendedSelector,elements=document.querySelectorAll(selector));let visibleElement=null;return elements.forEach((element=>{for(var elementtocheck=element.parentElement.parentElement;null!==elementtocheck&&!isHidden(elementtocheck);)elementtocheck=elementtocheck.parentElement;elementtocheck||(visibleElement=element)})),visibleElement}_exports.loadPreBookingPage=loadPreBookingPage}));

//# sourceMappingURL=bookit.min.js.map